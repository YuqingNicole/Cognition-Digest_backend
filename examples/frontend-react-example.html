<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google OAuth 登录示例</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 400px;
      width: 100%;
    }
    
    h1 {
      color: #333;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .user-card {
      text-align: center;
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 16px;
      border: 3px solid #667eea;
    }
    
    .user-name {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .user-email {
      color: #666;
      margin-bottom: 24px;
    }
    
    button {
      width: 100%;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-login {
      background: #4285f4;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    
    .btn-login:hover {
      background: #357ae8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
    }
    
    .btn-logout {
      background: #f44336;
      color: white;
    }
    
    .btn-logout:hover {
      background: #da190b;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
    }
    
    .api-demo {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #eee;
    }
    
    .api-demo h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .btn-api {
      background: #667eea;
      color: white;
      margin-bottom: 8px;
    }
    
    .btn-api:hover {
      background: #5568d3;
    }
    
    .api-result {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // 配置：修改为你的后端地址
    const API_BASE = 'http://localhost:4000';

    function App() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [apiResult, setApiResult] = useState(null);

      useEffect(() => {
        checkAuth();
      }, []);

      const checkAuth = async () => {
        try {
          const res = await fetch(`${API_BASE}/auth/me`, {
            credentials: 'include', // 重要：发送 Cookie
          });
          
          if (res.ok) {
            const data = await res.json();
            setUser(data);
          } else {
            setUser(null);
          }
        } catch (err) {
          console.error('Auth check failed:', err);
          setError('无法连接到后端服务器');
        } finally {
          setLoading(false);
        }
      };

      const handleLogin = () => {
        // 保存当前页面，登录后返回
        const currentUrl = window.location.href;
        window.location.href = `${API_BASE}/auth/google?redirect=${encodeURIComponent(currentUrl)}`;
      };

      const handleLogout = async () => {
        try {
          await fetch(`${API_BASE}/auth/logout`, {
            method: 'POST',
            credentials: 'include',
          });
          setUser(null);
          setApiResult(null);
        } catch (err) {
          console.error('Logout failed:', err);
          setError('登出失败');
        }
      };

      const testProtectedApi = async () => {
        try {
          setApiResult('加载中...');
          const res = await fetch(`${API_BASE}/api/report/test-1`, {
            credentials: 'include',
          });
          
          const data = await res.json();
          setApiResult(JSON.stringify(data, null, 2));
        } catch (err) {
          setApiResult(`错误: ${err.message}`);
        }
      };

      if (loading) {
        return (
          <div className="container">
            <div className="loading">
              <div className="spinner"></div>
              <p>加载中...</p>
            </div>
          </div>
        );
      }

      if (error) {
        return (
          <div className="container">
            <div className="error">{error}</div>
            <p style={{textAlign: 'center', color: '#666'}}>
              请确保后端服务器运行在 {API_BASE}
            </p>
          </div>
        );
      }

      if (!user) {
        return (
          <div className="container">
            <h1>欢迎使用</h1>
            <p style={{textAlign: 'center', color: '#666', marginBottom: '24px'}}>
              请使用 Google 账号登录
            </p>
            <button className="btn-login" onClick={handleLogin}>
              <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" fillRule="evenodd">
                  <path d="M17.6 9.2l-.1-1.8H9v3.4h4.8C13.6 12 13 13 12 13.6v2.2h3a8.8 8.8 0 0 0 2.6-6.6z" fill="#4285F4"/>
                  <path d="M9 18c2.4 0 4.5-.8 6-2.2l-3-2.2a5.4 5.4 0 0 1-8-2.9H1V13a9 9 0 0 0 8 5z" fill="#34A853"/>
                  <path d="M4 10.7a5.4 5.4 0 0 1 0-3.4V5H1a9 9 0 0 0 0 8l3-2.3z" fill="#FBBC05"/>
                  <path d="M9 3.6c1.3 0 2.5.4 3.4 1.3L15 2.3A9 9 0 0 0 1 5l3 2.4a5.4 5.4 0 0 1 5-3.7z" fill="#EA4335"/>
                </g>
              </svg>
              使用 Google 登录
            </button>
          </div>
        );
      }

      return (
        <div className="container">
          <h1>已登录</h1>
          <div className="user-card">
            {user.picture && (
              <img src={user.picture} alt={user.name} className="user-avatar" />
            )}
            <div className="user-name">{user.name}</div>
            <div className="user-email">{user.email}</div>
            <button className="btn-logout" onClick={handleLogout}>
              登出
            </button>
          </div>

          <div className="api-demo">
            <h3>测试受保护的 API</h3>
            <button className="btn-api" onClick={testProtectedApi}>
              调用 GET /api/report/test-1
            </button>
            {apiResult && (
              <pre className="api-result">{apiResult}</pre>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
